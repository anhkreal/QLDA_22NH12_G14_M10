{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
{% block title %}Chi tiết món ăn{% endblock %}
{% block content %}

<!-- PHẦN 1: Thông tin món ăn -->
<div class="row mb-5 shadow-sm bg-white p-4 rounded">
  <!-- Ảnh minh họa -->
  <div class="col-md-5 text-center">
    <img src="{% if dish.image %}data:image/jpeg;base64,{{ dish.image|b64encode }}{% else %}https://edeninterior.vn/wp-content/uploads/2024/05/thiet-ke-mat-tien-nha-hang-dep-1.jpg{% endif %}" class="img-fluid rounded" alt="Ảnh món ăn">
  </div>

  <!-- Thông tin chi tiết -->
  <div class="col-md-7 d-flex flex-column justify-content-center">
    <div class="ps-md-4">
      <h3 class="mb-3 fw-bold text-dark">{{ dish.name }}</h3>

      <!-- Đánh giá trung bình và số lượng đánh giá -->
      {% with total_reviews=reviews|length %}
        {% if total_reviews > 0 %}
          {% with total_star=0 %}
            {% for r in reviews %}
              {% with total_star=total_star|add:r.star %}
              {% endwith %}
            {% endfor %}
            {% with avg_rating=total_star|divisibleby:total_reviews %}
              <div class="mb-3 text-muted fs-5">
                <span class="text-warning fs-4">
                  {% with avg=total_star|floatformat:2 %}
                    {% with avg_rating=total_star|floatformat:1 %}
                      {% for i in "12345"|make_list %}
                        {% if i|add:'0' <= total_star|divisibleby:total_reviews %}
                          <i class="fas fa-star"></i>
                        {% else %}
                          <i class="far fa-star"></i>
                        {% endif %}
                      {% endfor %}
                    {% endwith %}
                  {% endwith %}
                </span>
                <span class="mx-2">| {{ total_reviews }} đánh giá |</span>
              </div>
            {% endwith %}
          {% endwith %}
        {% else %}
          <div class="mb-3 text-muted fs-5">
            <span class="text-warning fs-4">
              {% for i in "12345"|make_list %}
                <i class="far fa-star"></i>
              {% endfor %}
            </span>
            <span class="mx-2">| Chưa có đánh giá |</span>
          </div>
        {% endif %}
      {% endwith %}

      <div class="mb-3">
        <span class="fs-2 fw-bold text-danger">{{ dish.price|floatformat:0 }}đ</span>
      </div>

      <div class="mb-4 d-flex align-items-center">
        <label for="quantity" class="me-3 mb-0 fs-5">Số lượng:</label>
        <input type="number" id="quantity" class="form-control shadow-sm" value="1" min="1" style="width: 100px;">
      </div>

      <button class="btn btn-warning btn-lg px-4 shadow">
        <i class="fas fa-cart-plus me-2"></i>Thêm vào giỏ hàng
      </button>
    </div>
  </div>
</div>

<!-- PHẦN 2: Thông tin nhà hàng -->
<div class="card shadow-sm p-4 border-0 rounded bg-light mb-4">
  <div class="row align-items-center">
    <!-- Ảnh minh họa nhà hàng -->
    <div class="col-md-2 text-center mb-3 mb-md-0">
      <img src="{% if restaurant and restaurant.image %}data:image/jpeg;base64,{{ restaurant.image|b64encode }}{% else %}https://edeninterior.vn/wp-content/uploads/2024/05/thiet-ke-mat-tien-nha-hang-dep-1.jpg{% endif %}"
           class="rounded-circle border"
           alt="Ảnh nhà hàng"
           style="width: 80px; height: 80px; object-fit: cover;">
    </div>

    <!-- Tên nhà hàng và nút -->
    <div class="col-md-5">
      <div class="fw-bold fs-5 text-dark">{{ restaurant.name }}</div>
      <button type="button" id="view-restaurant-btn" data-restaurant-id="{{ restaurant.id }}" class="btn btn-sm btn-outline-warning mt-2">
        <i class="fas fa-store"></i> Xem nhà hàng
      </button>
    </div>

    <!-- Thông tin thêm -->
    <div class="col-md-5">
      <div class="mb-1"><strong>Sản phẩm:</strong> {{ dish.name }}</div>
      <div class="mb-1"><strong>Địa chỉ:</strong> {{ restaurant.street }}, {{ restaurant.district }}</div>
      <div>
        <strong>Thời gian vận chuyển:</strong> 30 - 40 phút |
        <strong>Phí vận chuyển:</strong> 15.000đ
      </div>
    </div>
  </div>
</div>

<!-- PHẦN 3: Đánh giá món ăn -->
<h4 class="mb-3 fw-bold text-dark">Đánh giá món ăn</h4>
<div class="list-group list-group-custom mb-4">
  {% if reviews %}
    {% for r in reviews %}
      <div class="list-group-item">
        <div class="d-flex flex-wrap align-items-center justify-content-between">
          <div>
            <span class="fw-semibold me-3"><i class="fas fa-phone"></i> {{ r.customer }}</span>
            <span class="me-3"><i class="fas fa-clock"></i> {{ r.time|default:"" }}</span>
            <span class="me-3"><i class="fas fa-map-marker-alt"></i> {{ r.address|default:"" }}</span>
          </div>
          <div>
            <span class="text-warning fs-5">
              {% for i in "12345"|make_list %}
                {% if i|add:'0' <= r.star|stringformat:"d" %}
                  <i class="fas fa-star"></i>
                {% else %}
                  <i class="far fa-star"></i>
                {% endif %}
              {% endfor %}
            </span>
          </div>
        </div>
        <div class="mt-2 text-dark">
          {{ r.comment|default:"" }}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="list-group-item">Chưa có đánh giá nào cho món ăn này.</div>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var btn = document.getElementById('view-restaurant-btn');
  if (btn) {
    btn.addEventListener('click', function() {
      var restId = btn.getAttribute('data-restaurant-id');
      if (restId) {
        window.location.href = "{% url 'restaurant-view-details' %}?id=" + encodeURIComponent(restId);
      }
    });
  }
});
</script>

{% endblock %}
