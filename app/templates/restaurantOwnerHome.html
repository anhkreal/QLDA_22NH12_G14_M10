{% extends "base2.html" %}
{% load custom_filters %}
{% load static %}
{% block content %}

<!-- PHẦN 1: Thông tin nhà hàng và mô tả -->
<div class="card shadow-sm p-4 mb-4 border-0 rounded bg-light">
  <div class="row align-items-center">
    <!-- Ảnh minh họa nhà hàng -->
    <div class="col-md-2 text-center mb-3 mb-md-0">
      <img src="{% if restaurant and restaurant.image %}data:image/jpeg;base64,{{ restaurant.image|b64encode }}{% else %}https://edeninterior.vn/wp-content/uploads/2024/05/thiet-ke-mat-tien-nha-hang-dep-1.jpg{% endif %}"
           class="rounded-circle border"
           alt="Ảnh nhà hàng"
           style="width: 90px; height: 90px; object-fit: cover;">
    </div>
    <!-- Thông tin nhà hàng -->
    <div class="col-md-7">
      <h3 class="fw-bold text-dark mb-2">
        {% if restaurant %}{{ restaurant.name }}{% else %}Tên nhà hàng{% endif %}
      </h3>
      <div class="mb-2"><strong>Địa chỉ:</strong>
        {% if restaurant %}
          {{ restaurant.street }}, {{ restaurant.district }}
        {% endif %}
      </div>
      {% if restaurant and restaurant.decription %}
      <div class="mb-2"><strong>Mô tả:</strong> {{ restaurant.decription }}</div>
      {% endif %}
    </div>
    <!-- Nút thông tin nhà hàng và thêm món ăn -->
    <div class="col-md-3 text-md-end mt-3 mt-md-0">
      <button class="btn btn-outline-info mb-2" type="button" id="restaurant-info-btn">
        <i class="fas fa-info-circle"></i> Thông tin nhà hàng
      </button>
      <br>
      <button class="btn btn-success {% if not restaurant %}disabled pointer-events-none opacity-50{% endif %}" id="add-dish-btn"><i class="fas fa-plus"></i> Thêm món ăn</button>
    </div>
  </div>
  {% if restaurant_message %}
    <div class="alert alert-warning mt-3 mb-0">{{ restaurant_message }}</div>
  {% endif %}
</div>

<!-- Mô tả nhà hàng -->
{% if restaurant and restaurant.decription %}
<div class="mb-4">
  <div class="bg-white rounded shadow-sm p-4 border">
    <h5 class="mb-3 text-secondary fw-bold">
      <i class="fas fa-info-circle me-2"></i>Mô tả nhà hàng
    </h5>
    <div class="text-dark" style="line-height:1.7;">
      {{ restaurant.decription }}
    </div>
  </div>
</div>
{% endif %}

<!-- PHẦN 2: Danh sách món ăn -->
<h4 class="mb-3 fw-bold text-dark">Danh sách món ăn</h4>
{% if dish_message %}
  <div class="alert alert-info">{{ dish_message }}</div>
{% endif %}
<div class="list-group list-group-custom" id="dish-list">
  {% for d in dishes %}
  <div class="list-group-item d-flex align-items-center justify-content-between flex-wrap py-3 px-2">
    <form class="d-flex align-items-center flex-grow-1 justify-content-between flex-wrap w-100">
      <div class="me-3 d-flex flex-column align-items-center">
        <img src="{% if d.dish.image %}data:image/jpeg;base64,{{ d.dish.image|b64encode }}{% else %}https://edeninterior.vn/wp-content/uploads/2024/05/thiet-ke-mat-tien-nha-hang-dep-1.jpg{% endif %}"
             class="rounded mb-2" style="width: 90px; height: 90px; object-fit: cover;">
        <input type="file" class="form-control form-control-sm" style="width:120px;">
      </div>
      <div class="me-3 flex-grow-1">
        <div class="mb-2">
          <input type="text" class="form-control fw-bold mb-1" value="{{ d.dish.name }}">
        </div>
        <div class="d-flex flex-wrap gap-3 align-items-center mb-2">
          <div>
            <span class="fw-semibold">Giá:</span>
            <input type="number" class="form-control d-inline-block" style="width:100px;display:inline;" value="{{ d.dish.price }}">
          </div>
          <div>
            <span class="fw-semibold">Đơn vị:</span>
            <input type="text" class="form-control d-inline-block" style="width:80px;display:inline;" value="{{ d.dish.unit }}">
          </div>
        </div>
        <div class="mb-2">
          <textarea class="form-control" rows="2">{{ d.dish.decription }}</textarea>
        </div>
        <div class="d-flex flex-wrap gap-4 align-items-center">
          <span>Đánh giá:
            <span class="text-warning">
              {% if d.avg_rating %}
                {% for i in "12345" %}
                  {% if i|add:'0' <= d.avg_rating|stringformat:"d" %}
                    ★
                  {% else %}
                    ☆
                  {% endif %}
                {% endfor %}
                ({{ d.avg_rating }}/5)
              {% else %}
                Chưa có
              {% endif %}
            </span>
          </span>
          <span>Số đánh giá: <span class="fw-bold">{{ d.num_ratings }}</span></span>
          <span>Số lượng mua: <span class="fw-bold">{{ d.total_quantity }}</span></span>
        </div>
      </div>
      <div class="d-flex flex-column gap-2 align-items-end">
        <button type="submit" class="btn btn-primary btn-sm mb-1"><i class="fas fa-save"></i> Lưu</button>
        <button type="button" class="btn btn-danger btn-sm"><i class="fas fa-trash"></i> Xóa</button>
        <button type="button" class="btn btn-outline-secondary btn-sm mt-2">
          <i class="fas fa-comments"></i> Xem đánh giá
        </button>
      </div>
    </form>
  </div>
  {% endfor %}
</div>

<script>
  // Sự kiện ẩn/hiện đánh giá cho món ăn đầu tiên
  document.addEventListener('DOMContentLoaded', function() {
    var btn = document.getElementById('toggle-review-btn');
    var reviewList = document.getElementById('review-list-1');
    if (btn && reviewList) {
      btn.addEventListener('click', function() {
        if (reviewList.style.display === 'none') {
          reviewList.style.display = 'block';
          btn.innerHTML = '<i class="fas fa-comments"></i> Ẩn đánh giá';
        } else {
          reviewList.style.display = 'none';
          btn.innerHTML = '<i class="fas fa-comments"></i> Xem đánh giá';
        }
      });
    }

    // Thêm món ăn mới (item trống)
    var addDishBtn = document.getElementById('add-dish-btn');
    var dishList = document.getElementById('dish-list');
    if (addDishBtn && dishList) {
      addDishBtn.addEventListener('click', function() {
        var newItem = document.createElement('div');
        newItem.className = 'list-group-item d-flex align-items-center justify-content-between flex-wrap py-3 px-2';
        newItem.innerHTML = `
          <form class="d-flex align-items-center flex-grow-1 justify-content-between flex-wrap w-100">
            <div class="me-3 d-flex flex-column align-items-center">
              <img src="" class="rounded mb-2" style="width: 90px; height: 90px; object-fit: cover; background:#eee;">
              <input type="file" class="form-control form-control-sm" style="width:120px;">
            </div>
            <div class="me-3 flex-grow-1">
              <div class="mb-2">
                <input type="text" class="form-control fw-bold mb-1" value="">
              </div>
              <div class="d-flex flex-wrap gap-3 align-items-center mb-2">
                <div>
                  <span class="fw-semibold">Giá:</span>
                  <input type="number" class="form-control d-inline-block" style="width:100px;display:inline;" value="">
                </div>
                <div>
                  <span class="fw-semibold">Đơn vị:</span>
                  <input type="text" class="form-control d-inline-block" style="width:80px;display:inline;" value="">
                </div>
              </div>
              <div class="mb-2">
                <textarea class="form-control" rows="2"></textarea>
              </div>
              <div class="d-flex flex-wrap gap-4 align-items-center">
                <span>Đánh giá: <span class="text-warning"></span></span>
                <span>Số đánh giá: <span class="fw-bold"></span></span>
                <span>Số lượng mua: <span class="fw-bold"></span></span>
              </div>
            </div>
            <div class="d-flex flex-column gap-2 align-items-end">
              <button type="submit" class="btn btn-success btn-sm mb-1"><i class="fas fa-plus"></i> Thêm</button>
              <button type="button" class="btn btn-secondary btn-sm"><i class="fas fa-times"></i> Hủy</button>
            </div>
          </form>
        `;
        dishList.insertBefore(newItem, dishList.firstChild);

        // Xử lý nút Hủy: xóa item mới khỏi danh sách
        var cancelBtn = newItem.querySelector('.btn-secondary');
        if (cancelBtn) {
          cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            newItem.remove();
          });
        }
      });
    }

    // Nút thông tin nhà hàng
    var infoBtn = document.getElementById('restaurant-info-btn');
    if (infoBtn) {
      infoBtn.addEventListener('click', function() {
        window.location.href = "{% url 'restaurant-info' %}";
      });
    }
  });
</script>

{% endblock %}
